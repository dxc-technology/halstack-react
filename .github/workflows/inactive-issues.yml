name: Close inactive issues
on:
  schedule:
    - cron: "* * * * *"

jobs:
  close-issues:
    runs-on: ubuntu-latest
    permissions:
      issues: write
      pull-requests: write
    steps:
      - name: Check if issue is closable
        id: check_issue
        uses: actions/github-script@v5
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const { owner, repo } = context.repo;
            const { data: issues } = await github.event.issues.listForRepo({
              owner,
              repo,
              labels: 'non-closable',
              state: 'open'
            }).catch(err => {
              console.error('Error fetching issues:', err.message);
              return { data: [] };
            });
            const issueNumbers = issues.map(issue => issue.number);
            const isClosable = issueNumbers.length === 0 || !issueNumbers.includes(context.issue.number);
            console.log(`Is issue closable: ${isClosable}`);
            console.log(`Issue numbers with non-closable label: ${issueNumbers}`);
            return { isClosable: isClosable };
      - name: Close stale issues
        if: steps.check_issue.outputs.isClosable
        uses: actions/stale@v5
        with:
          days-before-issue-stale: 0
          days-before-issue-close: 0
          stale-issue-label: "stale"
          stale-issue-message: "This issue is stale because it has been open for 15 days with no activity. If there are no further updates or modifications within the next 15 days, it will be automatically closed."
          close-issue-message: "This issue has been closed as it has been inactive for 15 days since being marked as stale."
          repo-token: ${{ secrets.GITHUB_TOKEN }}
    # steps:
    #   - name: Check for specific tags
    #     id: check_tags
    #     run: |
    #       TAGS=$(curl -s "https://api.github.com/repos/${GITHUB_REPOSITORY}/issues/${{ github.event.issue.number }}/labels" -H "Authorization: token ${GITHUB_TOKEN}" | jq -r '.[].name')
    #       if echo "$TAGS" | grep -q "dont-close"; then
    #         echo "::set-output name=close_issue::false"
    #       else
    #         echo "::set-output name=close_issue::true"
    #       fi

    #   - name: Close or mark as stale
    #     if: steps.check_tags.outputs.close_issue == 'true'
    #     uses: actions/stale@v5
    #     with:
    #       days-before-issue-stale: 15
    #       days-before-issue-close: 15
    #       stale-issue-label: "stale"
    #       stale-issue-message: "This issue is stale because it has been open for 15 days with no activity. If there are no further updates or modifications within the next 15 days, it will be automatically closed."
    #       close-issue-message: "This issue has been closed as it has been inactive for 15 days since being marked as stale."
    #       repo-token: ${{ secrets.GITHUB_TOKEN }}
